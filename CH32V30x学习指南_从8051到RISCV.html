<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CH32V30xå­¦ä¹ æŒ‡å— - ä»8051åˆ°RISC-V</title>
    <!-- Mermaid.js for diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --secondary: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --code-bg: #1e293b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.7;
        }

        /* å¯¼èˆª */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 280px;
            height: 100vh;
            background: var(--card);
            border-right: 1px solid var(--border);
            padding: 20px;
            overflow-y: auto;
            z-index: 100;
        }

        nav h2 {
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
            font-size: 1.1rem;
        }

        nav ul {
            list-style: none;
        }

        nav li {
            margin-bottom: 5px;
        }

        nav a {
            display: block;
            padding: 8px 12px;
            color: var(--text);
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        nav a:hover {
            background: var(--primary);
            color: white;
        }

        nav .chapter {
            font-weight: 600;
            color: var(--primary);
            margin-top: 15px;
        }

        /* ä¸»å†…å®¹ */
        main {
            margin-left: 280px;
            padding: 40px 60px;
            max-width: 1000px;
        }

        h1 {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .subtitle {
            color: var(--text-light);
            font-size: 1.2rem;
            margin-bottom: 40px;
        }

        h2 {
            font-size: 1.8rem;
            color: var(--text);
            margin: 50px 0 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        h3 {
            font-size: 1.3rem;
            color: var(--primary-dark);
            margin: 30px 0 15px;
        }

        h4 {
            font-size: 1.1rem;
            color: var(--text);
            margin: 20px 0 10px;
        }

        p {
            margin-bottom: 15px;
        }

        /* å¡ç‰‡ */
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
        }

        .card-title {
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* æç¤ºæ¡† */
        .tip {
            background: #ecfdf5;
            border-left: 4px solid var(--secondary);
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .tip-title {
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 5px;
        }

        .warning {
            background: #fffbeb;
            border-left: 4px solid var(--warning);
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .warning-title {
            font-weight: 600;
            color: var(--warning);
            margin-bottom: 5px;
        }

        .danger {
            background: #fef2f2;
            border-left: 4px solid var(--danger);
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .danger-title {
            font-weight: 600;
            color: var(--danger);
            margin-bottom: 5px;
        }

        /* ä»£ç å— */
        pre {
            background: var(--code-bg);
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        code {
            font-family: 'Consolas', 'Monaco', monospace;
            background: #e2e8f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
            color: var(--primary-dark);
        }

        pre code {
            background: none;
            padding: 0;
            color: inherit;
        }

        .code-comment { color: #6b7280; }
        .code-keyword { color: #c084fc; }
        .code-function { color: #60a5fa; }
        .code-string { color: #34d399; }
        .code-number { color: #fbbf24; }

        /* è¡¨æ ¼ */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.9rem;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border: 1px solid var(--border);
        }

        th {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background: #f8fafc;
        }

        tr:hover {
            background: #e0f2fe;
        }

        /* å¯¹æ¯”è§†å›¾ */
        .compare {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .compare-item {
            background: var(--card);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .compare-header {
            padding: 10px 15px;
            font-weight: 600;
            text-align: center;
        }

        .compare-item:first-child .compare-header {
            background: #fee2e2;
            color: var(--danger);
        }

        .compare-item:last-child .compare-header {
            background: #dcfce7;
            color: var(--secondary);
        }

        .compare-item pre {
            margin: 0;
            border-radius: 0;
        }

        /* å›¾è¡¨å®¹å™¨ */
        .diagram-container {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 30px;
            margin: 25px 0;
            text-align: center;
            overflow-x: auto;
        }

        .diagram-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        .mermaid {
            display: flex;
            justify-content: center;
        }

        /* SVGå›¾æ ·å¼ */
        .svg-diagram {
            max-width: 100%;
            height: auto;
        }

        .svg-diagram text {
            font-family: -apple-system, BlinkMacSystemFont, 'Microsoft YaHei', sans-serif;
        }

        /* è¿›åº¦æ¡ */
        .progress-container {
            display: flex;
            gap: 5px;
            margin: 20px 0;
        }

        .progress-step {
            flex: 1;
            text-align: center;
            padding: 15px 10px;
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 8px;
            position: relative;
        }

        .progress-step.active {
            border-color: var(--primary);
            background: #eff6ff;
        }

        .progress-step .step-num {
            width: 30px;
            height: 30px;
            background: var(--border);
            color: var(--text-light);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .progress-step.active .step-num {
            background: var(--primary);
            color: white;
        }

        .progress-step .step-title {
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* åˆ—è¡¨ */
        ul, ol {
            margin: 15px 0 15px 25px;
        }

        li {
            margin-bottom: 8px;
        }

        /* ç»ƒä¹ é¢˜ */
        .exercise {
            background: linear-gradient(135deg, #eff6ff 0%, #f0fdf4 100%);
            border: 2px dashed var(--primary);
            border-radius: 12px;
            padding: 25px;
            margin: 30px 0;
        }

        .exercise-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* APIå‚è€ƒ */
        .api-ref {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin: 15px 0;
            overflow: hidden;
        }

        .api-header {
            background: #f1f5f9;
            padding: 12px 15px;
            font-family: monospace;
            font-weight: 600;
            border-bottom: 1px solid var(--border);
        }

        .api-body {
            padding: 15px;
        }

        .api-param {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 10px;
            margin: 8px 0;
            font-size: 0.9rem;
        }

        .api-param-name {
            font-family: monospace;
            color: var(--primary);
        }

        /* å“åº”å¼ */
        @media (max-width: 900px) {
            nav {
                display: none;
            }
            main {
                margin-left: 0;
                padding: 20px;
            }
            .compare {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <nav>
        <h2>ğŸ“š å­¦ä¹ ç›®å½•</h2>
        <ul>
            <li><a href="#intro" class="chapter">ç¬¬ä¸€ç«  æ¦‚è¿°</a></li>
            <li><a href="#mindset">æ€ç»´è½¬å˜</a></li>
            <li><a href="#mapping">æ¦‚å¿µæ˜ å°„è¡¨</a></li>
            <li><a href="#architecture">æ¶æ„å¯¹æ¯”</a></li>

            <li><a href="#chapter2" class="chapter">ç¬¬äºŒç«  æ—¶é’Ÿç³»ç»Ÿ</a></li>
            <li><a href="#rcc-intro">RCCåŸºç¡€</a></li>
            <li><a href="#clock-tree">æ—¶é’Ÿæ ‘</a></li>
            <li><a href="#rcc-api">RCC API</a></li>

            <li><a href="#chapter3" class="chapter">ç¬¬ä¸‰ç«  GPIO</a></li>
            <li><a href="#gpio-modes">GPIOæ¨¡å¼</a></li>
            <li><a href="#gpio-init">åˆå§‹åŒ–æµç¨‹</a></li>
            <li><a href="#gpio-api">GPIO API</a></li>
            <li><a href="#gpio-exercise">LEDå®æˆ˜</a></li>

            <li><a href="#chapter4" class="chapter">ç¬¬å››ç«  å®šæ—¶å™¨</a></li>
            <li><a href="#tim-types">å®šæ—¶å™¨ç±»å‹</a></li>
            <li><a href="#tim-basic">åŸºæœ¬å®šæ—¶</a></li>
            <li><a href="#tim-nvic">NVICä¸­æ–­</a></li>
            <li><a href="#tim-exercise">å®šæ—¶å™¨å®æˆ˜</a></li>

            <li><a href="#chapter5" class="chapter">ç¬¬äº”ç«  ä¸²å£</a></li>
            <li><a href="#usart-init">USARTé…ç½®</a></li>
            <li><a href="#usart-printf">printfé‡å®šå‘</a></li>
            <li><a href="#usart-rx">æ¥æ”¶å¤„ç†</a></li>

            <li><a href="#chapter6" class="chapter">ç¬¬å…­ç«  ç»¼åˆé¡¹ç›®</a></li>
            <li><a href="#scheduler">ä»»åŠ¡è°ƒåº¦å™¨ç§»æ¤</a></li>
            <li><a href="#template">å·¥ç¨‹æ¨¡æ¿</a></li>

            <li><a href="#appendix" class="chapter">é™„å½•</a></li>
            <li><a href="#api-quick">APIé€ŸæŸ¥</a></li>
            <li><a href="#troubleshooting">å¸¸è§é—®é¢˜</a></li>
        </ul>
    </nav>

    <main>
        <h1>CH32V30x å­¦ä¹ æŒ‡å—</h1>
        <p class="subtitle">ä»8051åˆ°RISC-Vçš„å¹³æ»‘è¿‡æ¸¡ Â· åŸºäºä½ çš„å·¥ç¨‹åŒ…å®šåˆ¶</p>

        <!-- ç¬¬ä¸€ç«  -->
        <h2 id="intro">ç¬¬ä¸€ç«  æ¦‚è¿°ä¸æ€ç»´è½¬å˜</h2>

        <div class="card">
            <div class="card-title">ğŸ¯ æœ¬æŒ‡å—ç‰¹ç‚¹</div>
            <ul>
                <li>åŸºäºä½ å·²æœ‰çš„ <strong>STC15F2K60S2 (8051)</strong> ç»éªŒ</li>
                <li>é’ˆå¯¹ä½ çš„ <strong>CH32V30x v2.18</strong> å·¥ç¨‹åŒ…å®šåˆ¶</li>
                <li>ä»£ç å¯ç›´æ¥åœ¨ä½ çš„å·¥ç¨‹ä¸­è¿è¡Œ</li>
                <li>å¾ªåºæ¸è¿›ï¼Œæ¯ç« éƒ½æœ‰å®æˆ˜ç»ƒä¹ </li>
            </ul>
        </div>

        <h3 id="mindset">æ ¸å¿ƒæ€ç»´è½¬å˜</h3>

        <div class="warning">
            <div class="warning-title">âš ï¸ æœ€å¤§çš„åŒºåˆ«</div>
            <p><strong>8051</strong>ï¼šç›´æ¥æ“ä½œå¯„å­˜å™¨ï¼Œä¸Šç”µå°±èƒ½ç”¨</p>
            <p><strong>CH32</strong>ï¼šåº“å‡½æ•°å°è£…ï¼Œå¿…é¡»å…ˆå¼€æ—¶é’Ÿï¼</p>
        </div>

        <!-- æ€ç»´è½¬å˜æµç¨‹å›¾ -->
        <div class="diagram-container">
            <div class="diagram-title">å¼€å‘æ€ç»´å¯¹æ¯”</div>
            <div class="mermaid">
flowchart LR
    subgraph A["8051 å¼€å‘æµç¨‹"]
        direction TB
        A1["ğŸ’¡ æƒ³æ³•"] --> A2["ğŸ“ å†™å¯„å­˜å™¨"]
        A2 --> A3["âœ… å®Œæˆ"]
    end

    subgraph B["CH32 å¼€å‘æµç¨‹"]
        direction TB
        B1["ğŸ’¡ æƒ³æ³•"] --> B2["ğŸ”“ å¼€æ—¶é’Ÿ RCC"]
        B2 --> B3["ğŸ“‹ é…ç½®ç»“æ„ä½“"]
        B3 --> B4["âš™ï¸ è°ƒç”¨Initå‡½æ•°"]
        B4 --> B5["âœ… å®Œæˆ"]
    end

    A --> |"æ€ç»´å‡çº§"| B

    style A1 fill:#fef3c7
    style A2 fill:#fef3c7
    style A3 fill:#d1fae5
    style B1 fill:#dbeafe
    style B2 fill:#fee2e2
    style B3 fill:#dbeafe
    style B4 fill:#dbeafe
    style B5 fill:#d1fae5
            </div>
        </div>

        <div class="compare">
            <div class="compare-item">
                <div class="compare-header">8051 æ€ç»´</div>
<pre>
<span class="code-comment">// ç‚¹äº®LEDï¼Œä¸€è¡Œæå®š</span>
P1 = <span class="code-number">0xFE</span>;
</pre>
            </div>
            <div class="compare-item">
                <div class="compare-header">CH32 æ€ç»´</div>
<pre>
<span class="code-comment">// ç‚¹äº®LEDï¼Œå››æ­¥æµç¨‹</span>
<span class="code-number">1.</span> å¼€æ—¶é’Ÿ (RCC)
<span class="code-number">2.</span> é…ç½®ç»“æ„ä½“
<span class="code-number">3.</span> è°ƒç”¨Initå‡½æ•°
<span class="code-number">4.</span> æ“ä½œGPIO
</pre>
            </div>
        </div>

        <h3 id="mapping">æ¦‚å¿µæ˜ å°„è¡¨</h3>

        <table>
            <tr>
                <th>åŠŸèƒ½</th>
                <th>8051 (STC15)</th>
                <th>CH32V30x</th>
            </tr>
            <tr>
                <td>GPIOè¾“å‡º</td>
                <td><code>P0 = 0xFF</code></td>
                <td><code>GPIO_Write(GPIOA, 0xFF)</code></td>
            </tr>
            <tr>
                <td>å•å¼•è„šç½®é«˜</td>
                <td><code>P1_0 = 1</code></td>
                <td><code>GPIO_SetBits(GPIOA, GPIO_Pin_0)</code></td>
            </tr>
            <tr>
                <td>å•å¼•è„šç½®ä½</td>
                <td><code>P1_0 = 0</code></td>
                <td><code>GPIO_ResetBits(GPIOA, GPIO_Pin_0)</code></td>
            </tr>
            <tr>
                <td>è¯»å–å¼•è„š</td>
                <td><code>val = P1_0</code></td>
                <td><code>GPIO_ReadInputDataBit(GPIOA, GPIO_Pin_0)</code></td>
            </tr>
            <tr>
                <td>ä¸­æ–­å‡½æ•°</td>
                <td><code>void T0_ISR() interrupt 1</code></td>
                <td><code>void TIM2_IRQHandler(void)</code></td>
            </tr>
            <tr>
                <td>å®šæ—¶å™¨é…ç½®</td>
                <td><code>TMOD = 0x01; TH0=...; TL0=...</code></td>
                <td><code>TIM_TimeBaseInit(TIM2, &InitStruct)</code></td>
            </tr>
            <tr>
                <td>å¯åŠ¨å®šæ—¶å™¨</td>
                <td><code>TR0 = 1</code></td>
                <td><code>TIM_Cmd(TIM2, ENABLE)</code></td>
            </tr>
            <tr>
                <td>ä¸­æ–­ä½¿èƒ½</td>
                <td><code>ET0 = 1; EA = 1</code></td>
                <td><code>NVIC_Init(&NVIC_InitStruct)</code></td>
            </tr>
            <tr>
                <td>æ—¶é’Ÿæ§åˆ¶</td>
                <td><strong>æ— éœ€æ“ä½œ</strong></td>
                <td><code>RCC_APBxPeriphClockCmd(...)</code></td>
            </tr>
        </table>

        <h3 id="architecture">æ¶æ„å¯¹æ¯”</h3>

        <!-- 8051æ¶æ„å›¾ SVG -->
        <div class="diagram-container">
            <div class="diagram-title">8051 æ¶æ„ï¼ˆç®€å•ç›´æ¥ï¼‰</div>
            <svg class="svg-diagram" viewBox="0 0 700 280" xmlns="http://www.w3.org/2000/svg">
                <!-- èƒŒæ™¯ -->
                <defs>
                    <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#fef3c7;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#fde68a;stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="grad2" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#dbeafe;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#93c5fd;stop-opacity:1" />
                    </linearGradient>
                    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                        <feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.2"/>
                    </filter>
                </defs>

                <!-- æ ‡é¢˜èƒŒæ™¯ -->
                <rect x="10" y="10" width="680" height="260" rx="15" fill="#fffbeb" stroke="#fbbf24" stroke-width="2"/>

                <!-- CPU -->
                <rect x="280" y="40" width="140" height="60" rx="10" fill="url(#grad1)" stroke="#f59e0b" stroke-width="2" filter="url(#shadow)"/>
                <text x="350" y="75" text-anchor="middle" font-size="16" font-weight="bold" fill="#92400e">8051 CPU</text>

                <!-- ç®­å¤´ -->
                <path d="M350 100 L350 130" stroke="#f59e0b" stroke-width="3" marker-end="url(#arrowhead)"/>
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#f59e0b"/>
                    </marker>
                </defs>

                <!-- æ€»çº¿ -->
                <rect x="50" y="140" width="600" height="40" rx="8" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                <text x="350" y="165" text-anchor="middle" font-size="14" font-weight="bold" fill="#92400e">ç»Ÿä¸€æ€»çº¿ - æ‰€æœ‰å¤–è®¾å…±äº«</text>

                <!-- å¤–è®¾ -->
                <g transform="translate(50, 200)">
                    <rect x="0" y="0" width="100" height="50" rx="8" fill="url(#grad2)" stroke="#3b82f6" stroke-width="2" filter="url(#shadow)"/>
                    <text x="50" y="30" text-anchor="middle" font-size="14" font-weight="bold" fill="#1e40af">P0</text>
                </g>
                <g transform="translate(170, 200)">
                    <rect x="0" y="0" width="100" height="50" rx="8" fill="url(#grad2)" stroke="#3b82f6" stroke-width="2" filter="url(#shadow)"/>
                    <text x="50" y="30" text-anchor="middle" font-size="14" font-weight="bold" fill="#1e40af">P1</text>
                </g>
                <g transform="translate(290, 200)">
                    <rect x="0" y="0" width="100" height="50" rx="8" fill="url(#grad2)" stroke="#3b82f6" stroke-width="2" filter="url(#shadow)"/>
                    <text x="50" y="30" text-anchor="middle" font-size="14" font-weight="bold" fill="#1e40af">P2</text>
                </g>
                <g transform="translate(410, 200)">
                    <rect x="0" y="0" width="100" height="50" rx="8" fill="url(#grad2)" stroke="#3b82f6" stroke-width="2" filter="url(#shadow)"/>
                    <text x="50" y="30" text-anchor="middle" font-size="14" font-weight="bold" fill="#1e40af">P3</text>
                </g>
                <g transform="translate(530, 200)">
                    <rect x="0" y="0" width="100" height="50" rx="8" fill="url(#grad2)" stroke="#3b82f6" stroke-width="2" filter="url(#shadow)"/>
                    <text x="50" y="30" text-anchor="middle" font-size="14" font-weight="bold" fill="#1e40af">å®šæ—¶å™¨</text>
                </g>

                <!-- è¿æ¥çº¿ -->
                <line x1="100" y1="180" x2="100" y2="200" stroke="#3b82f6" stroke-width="2"/>
                <line x1="220" y1="180" x2="220" y2="200" stroke="#3b82f6" stroke-width="2"/>
                <line x1="340" y1="180" x2="340" y2="200" stroke="#3b82f6" stroke-width="2"/>
                <line x1="460" y1="180" x2="460" y2="200" stroke="#3b82f6" stroke-width="2"/>
                <line x1="580" y1="180" x2="580" y2="200" stroke="#3b82f6" stroke-width="2"/>
            </svg>
            <p style="color: #92400e; margin-top: 15px; font-size: 0.9rem;">âœ… ç®€å•ç›´æ¥ï¼šä¸Šç”µå³ç”¨ï¼Œæ— éœ€æ—¶é’Ÿé…ç½®</p>
        </div>

        <!-- CH32æ¶æ„å›¾ SVG -->
        <div class="diagram-container">
            <div class="diagram-title">CH32V30x æ¶æ„ï¼ˆæ¨¡å—åŒ–è®¾è®¡ï¼‰</div>
            <svg class="svg-diagram" viewBox="0 0 750 450" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="cpuGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#c7d2fe;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#a5b4fc;stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="rccGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#fecaca;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#fca5a5;stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="nvicGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#d9f99d;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#bef264;stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="apb2Grad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#99f6e4;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#5eead4;stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="apb1Grad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#fde68a;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#fcd34d;stop-opacity:1" />
                    </linearGradient>
                </defs>

                <!-- èƒŒæ™¯ -->
                <rect x="10" y="10" width="730" height="430" rx="15" fill="#f0fdf4" stroke="#22c55e" stroke-width="2"/>

                <!-- CPU -->
                <rect x="80" y="40" width="160" height="70" rx="12" fill="url(#cpuGrad)" stroke="#6366f1" stroke-width="2" filter="url(#shadow)"/>
                <text x="160" y="70" text-anchor="middle" font-size="14" font-weight="bold" fill="#3730a3">RISC-V CPU</text>
                <text x="160" y="90" text-anchor="middle" font-size="12" fill="#4f46e5">96MHz é«˜æ€§èƒ½</text>

                <!-- RCC -->
                <rect x="300" y="40" width="160" height="70" rx="12" fill="url(#rccGrad)" stroke="#ef4444" stroke-width="2" filter="url(#shadow)"/>
                <text x="380" y="65" text-anchor="middle" font-size="14" font-weight="bold" fill="#991b1b">ğŸ”‘ RCC</text>
                <text x="380" y="85" text-anchor="middle" font-size="12" fill="#b91c1c">æ—¶é’Ÿæ§åˆ¶å™¨</text>
                <text x="380" y="100" text-anchor="middle" font-size="10" fill="#dc2626">(å¿…é¡»å…ˆå¼€!)</text>

                <!-- NVIC -->
                <rect x="520" y="40" width="160" height="70" rx="12" fill="url(#nvicGrad)" stroke="#84cc16" stroke-width="2" filter="url(#shadow)"/>
                <text x="600" y="70" text-anchor="middle" font-size="14" font-weight="bold" fill="#365314">NVIC</text>
                <text x="600" y="90" text-anchor="middle" font-size="12" fill="#4d7c0f">ä¸­æ–­æ§åˆ¶å™¨</text>

                <!-- è¿æ¥çº¿ CPU-RCC -->
                <path d="M240 75 L300 75" stroke="#6366f1" stroke-width="2" stroke-dasharray="5,3"/>
                <path d="M460 75 L520 75" stroke="#84cc16" stroke-width="2" stroke-dasharray="5,3"/>

                <!-- SYSCLK -->
                <rect x="280" y="140" width="200" height="40" rx="8" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                <text x="380" y="165" text-anchor="middle" font-size="13" font-weight="bold" fill="#92400e">SYSCLK (96MHz)</text>

                <!-- æ—¶é’Ÿåˆ†é…ç®­å¤´ -->
                <path d="M380 110 L380 140" stroke="#ef4444" stroke-width="2" marker-end="url(#arrowhead)"/>
                <path d="M380 180 L380 210" stroke="#f59e0b" stroke-width="2"/>
                <path d="M380 210 L200 210 L200 240" stroke="#14b8a6" stroke-width="2"/>
                <path d="M380 210 L560 210 L560 240" stroke="#eab308" stroke-width="2"/>

                <!-- APB2 åŒºåŸŸ -->
                <rect x="40" y="240" width="320" height="190" rx="12" fill="#ecfdf5" stroke="#14b8a6" stroke-width="2"/>
                <text x="200" y="265" text-anchor="middle" font-size="14" font-weight="bold" fill="#0f766e">APB2 æ€»çº¿ (96MHz) - é«˜é€Ÿå¤–è®¾</text>

                <!-- APB2 å¤–è®¾ -->
                <rect x="60" y="285" width="90" height="40" rx="6" fill="url(#apb2Grad)" stroke="#14b8a6" stroke-width="1.5"/>
                <text x="105" y="310" text-anchor="middle" font-size="12" font-weight="bold" fill="#115e59">GPIOA~E</text>

                <rect x="160" y="285" width="90" height="40" rx="6" fill="url(#apb2Grad)" stroke="#14b8a6" stroke-width="1.5"/>
                <text x="205" y="310" text-anchor="middle" font-size="12" font-weight="bold" fill="#115e59">USART1</text>

                <rect x="260" y="285" width="90" height="40" rx="6" fill="url(#apb2Grad)" stroke="#14b8a6" stroke-width="1.5"/>
                <text x="305" y="310" text-anchor="middle" font-size="12" font-weight="bold" fill="#115e59">SPI1</text>

                <rect x="60" y="340" width="90" height="40" rx="6" fill="url(#apb2Grad)" stroke="#14b8a6" stroke-width="1.5"/>
                <text x="105" y="365" text-anchor="middle" font-size="12" font-weight="bold" fill="#115e59">ADC1,2</text>

                <rect x="160" y="340" width="90" height="40" rx="6" fill="url(#apb2Grad)" stroke="#14b8a6" stroke-width="1.5"/>
                <text x="205" y="365" text-anchor="middle" font-size="12" font-weight="bold" fill="#115e59">TIM1,8</text>

                <rect x="260" y="340" width="90" height="40" rx="6" fill="url(#apb2Grad)" stroke="#14b8a6" stroke-width="1.5"/>
                <text x="305" y="365" text-anchor="middle" font-size="12" font-weight="bold" fill="#115e59">TIM9,10</text>

                <!-- å¼€å…³å›¾æ ‡ -->
                <g transform="translate(60, 395)">
                    <rect x="0" y="0" width="290" height="25" rx="4" fill="#d1fae5"/>
                    <text x="145" y="17" text-anchor="middle" font-size="11" fill="#047857">ğŸ”Œ æ¯ä¸ªå¤–è®¾éƒ½æœ‰ç‹¬ç«‹æ—¶é’Ÿå¼€å…³</text>
                </g>

                <!-- APB1 åŒºåŸŸ -->
                <rect x="390" y="240" width="320" height="190" rx="12" fill="#fefce8" stroke="#eab308" stroke-width="2"/>
                <text x="550" y="265" text-anchor="middle" font-size="14" font-weight="bold" fill="#a16207">APB1 æ€»çº¿ (48MHz) - ä½é€Ÿå¤–è®¾</text>

                <!-- APB1 å¤–è®¾ -->
                <rect x="410" y="285" width="90" height="40" rx="6" fill="url(#apb1Grad)" stroke="#eab308" stroke-width="1.5"/>
                <text x="455" y="310" text-anchor="middle" font-size="12" font-weight="bold" fill="#854d0e">TIM2~7</text>

                <rect x="510" y="285" width="90" height="40" rx="6" fill="url(#apb1Grad)" stroke="#eab308" stroke-width="1.5"/>
                <text x="555" y="310" text-anchor="middle" font-size="12" font-weight="bold" fill="#854d0e">USART2~5</text>

                <rect x="610" y="285" width="90" height="40" rx="6" fill="url(#apb1Grad)" stroke="#eab308" stroke-width="1.5"/>
                <text x="655" y="310" text-anchor="middle" font-size="12" font-weight="bold" fill="#854d0e">SPI2,3</text>

                <rect x="410" y="340" width="90" height="40" rx="6" fill="url(#apb1Grad)" stroke="#eab308" stroke-width="1.5"/>
                <text x="455" y="365" text-anchor="middle" font-size="12" font-weight="bold" fill="#854d0e">I2C1,2</text>

                <rect x="510" y="340" width="90" height="40" rx="6" fill="url(#apb1Grad)" stroke="#eab308" stroke-width="1.5"/>
                <text x="555" y="365" text-anchor="middle" font-size="12" font-weight="bold" fill="#854d0e">CAN1,2</text>

                <rect x="610" y="340" width="90" height="40" rx="6" fill="url(#apb1Grad)" stroke="#eab308" stroke-width="1.5"/>
                <text x="655" y="365" text-anchor="middle" font-size="12" font-weight="bold" fill="#854d0e">DAC</text>

                <!-- å¼€å…³å›¾æ ‡ -->
                <g transform="translate(410, 395)">
                    <rect x="0" y="0" width="290" height="25" rx="4" fill="#fef9c3"/>
                    <text x="145" y="17" text-anchor="middle" font-size="11" fill="#a16207">ğŸ”Œ æ¯ä¸ªå¤–è®¾éƒ½æœ‰ç‹¬ç«‹æ—¶é’Ÿå¼€å…³</text>
                </g>
            </svg>
            <p style="color: #166534; margin-top: 15px; font-size: 0.9rem;">âš ï¸ é‡è¦ï¼šä½¿ç”¨ä»»ä½•å¤–è®¾å‰ï¼Œå¿…é¡»å…ˆé€šè¿‡RCCå¼€å¯å¯¹åº”çš„æ—¶é’Ÿï¼</p>
        </div>

        <!-- ç¬¬äºŒç«  -->
        <h2 id="chapter2">ç¬¬äºŒç«  æ—¶é’Ÿç³»ç»Ÿ (RCC)</h2>

        <div class="danger">
            <div class="danger-title">ğŸš¨ è¿™æ˜¯8051å¼€å‘è€…æœ€å®¹æ˜“å¿½ç•¥çš„ï¼</div>
            <p>åœ¨CH32ä¸­ï¼Œ<strong>æ¯ä¸ªå¤–è®¾åœ¨ä½¿ç”¨å‰å¿…é¡»å…ˆå¼€å¯æ—¶é’Ÿ</strong>ï¼Œå¦åˆ™å¤–è®¾ä¸ä¼šå·¥ä½œã€‚è¿™æ˜¯ä¸ºäº†é™ä½åŠŸè€—è®¾è®¡çš„ã€‚</p>
        </div>

        <h3 id="rcc-intro">RCC åŸºç¡€æ¦‚å¿µ</h3>

        <p><strong>RCC (Reset and Clock Control)</strong> æ˜¯æ—¶é’Ÿæ§åˆ¶å™¨ï¼Œè´Ÿè´£ï¼š</p>
        <ul>
            <li>ç³»ç»Ÿæ—¶é’Ÿé…ç½®ï¼ˆHSI/HSE/PLLï¼‰</li>
            <li>æ€»çº¿æ—¶é’Ÿåˆ†é¢‘ï¼ˆAHB/APB1/APB2ï¼‰</li>
            <li><strong>å¤–è®¾æ—¶é’Ÿé—¨æ§</strong>ï¼ˆå¼€å¯/å…³é—­å„å¤–è®¾æ—¶é’Ÿï¼‰</li>
        </ul>

        <h3 id="clock-tree">æ—¶é’Ÿæ ‘è¯¦è§£</h3>

        <!-- æ—¶é’Ÿæ ‘ Mermaid -->
        <div class="diagram-container">
            <div class="diagram-title">CH32V30x æ—¶é’Ÿæ ‘</div>
            <div class="mermaid">
flowchart TB
    subgraph Sources["æ—¶é’Ÿæº"]
        HSI["ğŸ”· HSI<br/>å†…éƒ¨8MHz"]
        HSE["ğŸ”¶ HSE<br/>å¤–éƒ¨æ™¶æŒ¯8MHz"]
    end

    subgraph PLL["é”ç›¸ç¯å€é¢‘"]
        PLLMUL["PLLå€é¢‘å™¨<br/>Ã—12"]
    end

    subgraph System["ç³»ç»Ÿæ—¶é’Ÿ"]
        SYSCLK["âš¡ SYSCLK<br/>96MHz"]
    end

    subgraph Buses["æ€»çº¿æ—¶é’Ÿ"]
        AHB["AHB<br/>96MHz"]
        APB2["APB2 é«˜é€Ÿ<br/>96MHz"]
        APB1["APB1 ä½é€Ÿ<br/>48MHz"]
    end

    subgraph APB2_Periph["APB2 å¤–è®¾"]
        GPIO["GPIOA~E"]
        USART1["USART1"]
        SPI1["SPI1"]
        ADC["ADC1,2"]
        TIM_H["TIM1,8,9,10"]
    end

    subgraph APB1_Periph["APB1 å¤–è®¾"]
        TIM_L["TIM2~7"]
        USART_L["USART2~5"]
        SPI_L["SPI2,3"]
        I2C["I2C1,2"]
        CAN["CAN1,2"]
    end

    HSI --> PLLMUL
    HSE --> PLLMUL
    PLLMUL --> SYSCLK
    SYSCLK --> AHB
    AHB --> APB2
    AHB --> APB1

    APB2 --> GPIO
    APB2 --> USART1
    APB2 --> SPI1
    APB2 --> ADC
    APB2 --> TIM_H

    APB1 --> TIM_L
    APB1 --> USART_L
    APB1 --> SPI_L
    APB1 --> I2C
    APB1 --> CAN

    style HSE fill:#fef3c7,stroke:#f59e0b
    style PLLMUL fill:#dbeafe,stroke:#3b82f6
    style SYSCLK fill:#fee2e2,stroke:#ef4444
    style APB2 fill:#d1fae5,stroke:#10b981
    style APB1 fill:#fef9c3,stroke:#eab308
            </div>
        </div>

        <h3 id="rcc-api">RCC å¸¸ç”¨API</h3>

        <div class="api-ref">
            <div class="api-header">RCC_APB2PeriphClockCmd(uint32_t Periph, FunctionalState NewState)</div>
            <div class="api-body">
                <p>å¼€å¯/å…³é—­ APB2 æ€»çº¿ä¸Šçš„å¤–è®¾æ—¶é’Ÿ</p>
                <div class="api-param">
                    <span class="api-param-name">Periph</span>
                    <span>å¤–è®¾å®ï¼Œå¦‚ <code>RCC_APB2Periph_GPIOC</code>ã€<code>RCC_APB2Periph_USART1</code></span>
                </div>
                <div class="api-param">
                    <span class="api-param-name">NewState</span>
                    <span><code>ENABLE</code> æˆ– <code>DISABLE</code></span>
                </div>
            </div>
        </div>

        <div class="api-ref">
            <div class="api-header">RCC_APB1PeriphClockCmd(uint32_t Periph, FunctionalState NewState)</div>
            <div class="api-body">
                <p>å¼€å¯/å…³é—­ APB1 æ€»çº¿ä¸Šçš„å¤–è®¾æ—¶é’Ÿ</p>
                <div class="api-param">
                    <span class="api-param-name">Periph</span>
                    <span>å¤–è®¾å®ï¼Œå¦‚ <code>RCC_APB1Periph_TIM3</code>ã€<code>RCC_APB1Periph_USART2</code></span>
                </div>
            </div>
        </div>

        <div class="tip">
            <div class="tip-title">ğŸ’¡ è®°å¿†æŠ€å·§</div>
            <p><strong>APB2</strong> = é«˜é€Ÿ = GPIOå…¨å®¶ + USART1 + SPI1 + ADC + é«˜çº§å®šæ—¶å™¨(TIM1,8)</p>
            <p><strong>APB1</strong> = ä½é€Ÿ = TIM2~7 + USART2~5 + SPI2,3 + I2C</p>
        </div>

        <h4>å¸¸ç”¨å¤–è®¾æ—¶é’Ÿå®</h4>

        <table>
            <tr>
                <th>APB2 å¤–è®¾ (é«˜é€Ÿ)</th>
                <th>APB1 å¤–è®¾ (ä½é€Ÿ)</th>
            </tr>
            <tr>
                <td><code>RCC_APB2Periph_GPIOA</code></td>
                <td><code>RCC_APB1Periph_TIM2</code></td>
            </tr>
            <tr>
                <td><code>RCC_APB2Periph_GPIOB</code></td>
                <td><code>RCC_APB1Periph_TIM3</code></td>
            </tr>
            <tr>
                <td><code>RCC_APB2Periph_GPIOC</code></td>
                <td><code>RCC_APB1Periph_TIM4</code></td>
            </tr>
            <tr>
                <td><code>RCC_APB2Periph_GPIOD</code></td>
                <td><code>RCC_APB1Periph_USART2</code></td>
            </tr>
            <tr>
                <td><code>RCC_APB2Periph_USART1</code></td>
                <td><code>RCC_APB1Periph_I2C1</code></td>
            </tr>
            <tr>
                <td><code>RCC_APB2Periph_SPI1</code></td>
                <td><code>RCC_APB1Periph_SPI2</code></td>
            </tr>
            <tr>
                <td><code>RCC_APB2Periph_ADC1</code></td>
                <td><code>RCC_APB1Periph_CAN1</code></td>
            </tr>
        </table>

        <!-- ç¬¬ä¸‰ç«  -->
        <h2 id="chapter3">ç¬¬ä¸‰ç«  GPIO è¯¦è§£</h2>

        <h3 id="gpio-modes">GPIO æ¨¡å¼è¯¦è§£</h3>

        <table>
            <tr>
                <th>æ¨¡å¼</th>
                <th>å®å®šä¹‰</th>
                <th>ç”¨é€”</th>
                <th>8051å¯¹åº”</th>
            </tr>
            <tr>
                <td>æ¨æŒ½è¾“å‡º</td>
                <td><code>GPIO_Mode_Out_PP</code></td>
                <td>LEDã€èœ‚é¸£å™¨ç­‰</td>
                <td>P0å£å¤–æ¥ä¸Šæ‹‰</td>
            </tr>
            <tr>
                <td>å¼€æ¼è¾“å‡º</td>
                <td><code>GPIO_Mode_Out_OD</code></td>
                <td>I2Cã€ç”µå¹³è½¬æ¢</td>
                <td>P0å£é»˜è®¤</td>
            </tr>
            <tr>
                <td>æµ®ç©ºè¾“å…¥</td>
                <td><code>GPIO_Mode_IN_FLOATING</code></td>
                <td>å¤–éƒ¨æœ‰ç¡®å®šç”µå¹³</td>
                <td>P1~P3å£</td>
            </tr>
            <tr>
                <td>ä¸Šæ‹‰è¾“å…¥</td>
                <td><code>GPIO_Mode_IPU</code></td>
                <td>æŒ‰é”®ï¼ˆä½ç”µå¹³æœ‰æ•ˆï¼‰</td>
                <td>-</td>
            </tr>
            <tr>
                <td>ä¸‹æ‹‰è¾“å…¥</td>
                <td><code>GPIO_Mode_IPD</code></td>
                <td>æŒ‰é”®ï¼ˆé«˜ç”µå¹³æœ‰æ•ˆï¼‰</td>
                <td>-</td>
            </tr>
            <tr>
                <td>æ¨¡æ‹Ÿè¾“å…¥</td>
                <td><code>GPIO_Mode_AIN</code></td>
                <td>ADCé‡‡é›†</td>
                <td>-</td>
            </tr>
            <tr>
                <td>å¤ç”¨æ¨æŒ½</td>
                <td><code>GPIO_Mode_AF_PP</code></td>
                <td>USART_TXã€SPIç­‰</td>
                <td>-</td>
            </tr>
            <tr>
                <td>å¤ç”¨å¼€æ¼</td>
                <td><code>GPIO_Mode_AF_OD</code></td>
                <td>I2C_SDA/SCL</td>
                <td>-</td>
            </tr>
        </table>

        <!-- GPIOæ¨¡å¼å›¾ -->
        <div class="diagram-container">
            <div class="diagram-title">GPIO è¾“å‡ºæ¨¡å¼å¯¹æ¯”</div>
            <svg class="svg-diagram" viewBox="0 0 700 300" xmlns="http://www.w3.org/2000/svg">
                <!-- æ¨æŒ½è¾“å‡º -->
                <g transform="translate(50, 30)">
                    <text x="120" y="0" text-anchor="middle" font-size="16" font-weight="bold" fill="#2563eb">æ¨æŒ½è¾“å‡º (Out_PP)</text>

                    <!-- VDD -->
                    <line x1="120" y1="30" x2="120" y2="50" stroke="#ef4444" stroke-width="2"/>
                    <text x="140" y="45" font-size="12" fill="#ef4444">VDD</text>

                    <!-- P-MOS -->
                    <rect x="100" y="50" width="40" height="30" fill="#fecaca" stroke="#ef4444" stroke-width="2" rx="4"/>
                    <text x="120" y="70" text-anchor="middle" font-size="10" fill="#991b1b">P-MOS</text>

                    <!-- è¾“å‡ºç‚¹ -->
                    <line x1="120" y1="80" x2="120" y2="100" stroke="#1e293b" stroke-width="2"/>
                    <circle cx="120" cy="100" r="5" fill="#3b82f6"/>
                    <line x1="125" y1="100" x2="180" y2="100" stroke="#3b82f6" stroke-width="2"/>
                    <text x="190" y="105" font-size="12" font-weight="bold" fill="#3b82f6">è¾“å‡º</text>

                    <!-- N-MOS -->
                    <line x1="120" y1="100" x2="120" y2="120" stroke="#1e293b" stroke-width="2"/>
                    <rect x="100" y="120" width="40" height="30" fill="#dbeafe" stroke="#3b82f6" stroke-width="2" rx="4"/>
                    <text x="120" y="140" text-anchor="middle" font-size="10" fill="#1e40af">N-MOS</text>

                    <!-- GND -->
                    <line x1="120" y1="150" x2="120" y2="170" stroke="#1e293b" stroke-width="2"/>
                    <text x="140" y="165" font-size="12" fill="#64748b">GND</text>

                    <!-- è¯´æ˜ -->
                    <rect x="30" y="190" width="180" height="60" fill="#eff6ff" stroke="#3b82f6" rx="6"/>
                    <text x="120" y="210" text-anchor="middle" font-size="11" fill="#1e40af">âœ… å¯è¾“å‡ºé«˜/ä½ç”µå¹³</text>
                    <text x="120" y="228" text-anchor="middle" font-size="11" fill="#1e40af">âœ… é©±åŠ¨èƒ½åŠ›å¼º</text>
                    <text x="120" y="246" text-anchor="middle" font-size="11" fill="#1e40af">ğŸ“ ç”¨äºLEDã€èœ‚é¸£å™¨</text>
                </g>

                <!-- å¼€æ¼è¾“å‡º -->
                <g transform="translate(350, 30)">
                    <text x="120" y="0" text-anchor="middle" font-size="16" font-weight="bold" fill="#f59e0b">å¼€æ¼è¾“å‡º (Out_OD)</text>

                    <!-- å¤–éƒ¨ä¸Šæ‹‰ -->
                    <line x1="120" y1="30" x2="120" y2="50" stroke="#ef4444" stroke-width="2" stroke-dasharray="4"/>
                    <text x="140" y="45" font-size="12" fill="#ef4444">å¤–éƒ¨ä¸Šæ‹‰</text>

                    <!-- æ–­å¼€çš„P-MOS -->
                    <rect x="100" y="50" width="40" height="30" fill="#f1f5f9" stroke="#94a3b8" stroke-width="2" rx="4" stroke-dasharray="4"/>
                    <text x="120" y="70" text-anchor="middle" font-size="10" fill="#94a3b8">æ— </text>

                    <!-- è¾“å‡ºç‚¹ -->
                    <line x1="120" y1="80" x2="120" y2="100" stroke="#1e293b" stroke-width="2"/>
                    <circle cx="120" cy="100" r="5" fill="#f59e0b"/>
                    <line x1="125" y1="100" x2="180" y2="100" stroke="#f59e0b" stroke-width="2"/>
                    <text x="190" y="105" font-size="12" font-weight="bold" fill="#f59e0b">è¾“å‡º</text>

                    <!-- N-MOS -->
                    <line x1="120" y1="100" x2="120" y2="120" stroke="#1e293b" stroke-width="2"/>
                    <rect x="100" y="120" width="40" height="30" fill="#fef3c7" stroke="#f59e0b" stroke-width="2" rx="4"/>
                    <text x="120" y="140" text-anchor="middle" font-size="10" fill="#92400e">N-MOS</text>

                    <!-- GND -->
                    <line x1="120" y1="150" x2="120" y2="170" stroke="#1e293b" stroke-width="2"/>
                    <text x="140" y="165" font-size="12" fill="#64748b">GND</text>

                    <!-- è¯´æ˜ -->
                    <rect x="30" y="190" width="180" height="60" fill="#fefce8" stroke="#f59e0b" rx="6"/>
                    <text x="120" y="210" text-anchor="middle" font-size="11" fill="#92400e">âš ï¸ åªèƒ½æ‹‰ä½ï¼Œéœ€å¤–éƒ¨ä¸Šæ‹‰</text>
                    <text x="120" y="228" text-anchor="middle" font-size="11" fill="#92400e">âœ… æ”¯æŒçº¿ä¸é€»è¾‘</text>
                    <text x="120" y="246" text-anchor="middle" font-size="11" fill="#92400e">ğŸ“ ç”¨äºI2Cã€ç”µå¹³è½¬æ¢</text>
                </g>
            </svg>
        </div>

        <h3 id="gpio-init">GPIO åˆå§‹åŒ–æµç¨‹</h3>

        <!-- GPIOåˆå§‹åŒ–æµç¨‹å›¾ -->
        <div class="diagram-container">
            <div class="diagram-title">GPIO åˆå§‹åŒ–å››æ­¥æµç¨‹</div>
            <div class="mermaid">
flowchart LR
    A["1ï¸âƒ£ å¼€æ—¶é’Ÿ<br/><code>RCC_APB2PeriphClockCmd</code>"] --> B["2ï¸âƒ£ å®šä¹‰ç»“æ„ä½“<br/><code>GPIO_InitTypeDef</code>"]
    B --> C["3ï¸âƒ£ å¡«å……æˆå‘˜<br/>Pin/Mode/Speed"]
    C --> D["4ï¸âƒ£ è°ƒç”¨Init<br/><code>GPIO_Init()</code>"]

    style A fill:#fee2e2,stroke:#ef4444,stroke-width:2px
    style B fill:#dbeafe,stroke:#3b82f6,stroke-width:2px
    style C fill:#d1fae5,stroke:#10b981,stroke-width:2px
    style D fill:#fef3c7,stroke:#f59e0b,stroke-width:2px
            </div>
        </div>

<pre>
<span class="code-comment">// GPIOåˆå§‹åŒ–å®Œæ•´æ¨¡æ¿</span>
<span class="code-keyword">void</span> <span class="code-function">LED_Init</span>(<span class="code-keyword">void</span>)
{
    <span class="code-comment">// ç¬¬1æ­¥ï¼šå¼€å¯GPIOCæ—¶é’Ÿ ã€å¿…é¡»ï¼8051æ— æ­¤æ­¥éª¤ã€‘</span>
    <span class="code-function">RCC_APB2PeriphClockCmd</span>(RCC_APB2Periph_GPIOC, ENABLE);

    <span class="code-comment">// ç¬¬2æ­¥ï¼šå®šä¹‰GPIOåˆå§‹åŒ–ç»“æ„ä½“</span>
    GPIO_InitTypeDef GPIO_InitStructure = {<span class="code-number">0</span>};

    <span class="code-comment">// ç¬¬3æ­¥ï¼šå¡«å……ç»“æ„ä½“æˆå‘˜</span>
    GPIO_InitStructure.GPIO_Pin   = GPIO_Pin_2;          <span class="code-comment">// PC2å¼•è„š</span>
    GPIO_InitStructure.GPIO_Mode  = GPIO_Mode_Out_PP;    <span class="code-comment">// æ¨æŒ½è¾“å‡º</span>
    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;    <span class="code-comment">// ç¿»è½¬é€Ÿåº¦</span>

    <span class="code-comment">// ç¬¬4æ­¥ï¼šè°ƒç”¨åˆå§‹åŒ–å‡½æ•°</span>
    <span class="code-function">GPIO_Init</span>(GPIOC, &GPIO_InitStructure);
}
</pre>

        <h3 id="gpio-api">GPIO å¸¸ç”¨API</h3>

        <div class="api-ref">
            <div class="api-header">GPIO_SetBits(GPIO_TypeDef* GPIOx, uint16_t GPIO_Pin)</div>
            <div class="api-body">
                <p>å°†æŒ‡å®šå¼•è„šç½®é«˜ (è¾“å‡º1)</p>
<pre>
<span class="code-comment">// ç­‰ä»·äº 8051 çš„ P1_0 = 1;</span>
<span class="code-function">GPIO_SetBits</span>(GPIOC, GPIO_Pin_2);
</pre>
            </div>
        </div>

        <div class="api-ref">
            <div class="api-header">GPIO_ResetBits(GPIO_TypeDef* GPIOx, uint16_t GPIO_Pin)</div>
            <div class="api-body">
                <p>å°†æŒ‡å®šå¼•è„šç½®ä½ (è¾“å‡º0)</p>
<pre>
<span class="code-comment">// ç­‰ä»·äº 8051 çš„ P1_0 = 0;</span>
<span class="code-function">GPIO_ResetBits</span>(GPIOC, GPIO_Pin_2);
</pre>
            </div>
        </div>

        <div class="api-ref">
            <div class="api-header">GPIO_ReadInputDataBit(GPIO_TypeDef* GPIOx, uint16_t GPIO_Pin)</div>
            <div class="api-body">
                <p>è¯»å–è¾“å…¥å¼•è„šç”µå¹³ï¼Œè¿”å› Bit_SET(1) æˆ– Bit_RESET(0)</p>
<pre>
<span class="code-comment">// ç­‰ä»·äº 8051 çš„ if(P1_0 == 0)</span>
<span class="code-keyword">if</span>(<span class="code-function">GPIO_ReadInputDataBit</span>(GPIOA, GPIO_Pin_0) == Bit_RESET) {
    <span class="code-comment">// æŒ‰é”®æŒ‰ä¸‹</span>
}
</pre>
            </div>
        </div>

        <h3 id="gpio-exercise">å®æˆ˜ç»ƒä¹ ï¼šLEDé—ªçƒ</h3>

        <div class="exercise">
            <div class="exercise-title">ğŸ“ ç»ƒä¹ 1ï¼šè®©PC2å¼•è„šçš„LEDæ¯500msé—ªçƒä¸€æ¬¡</div>
            <p>åœ¨ä½ çš„å·¥ç¨‹ <code>ç¬¬ä¸€è®²/v2.18/User/main.c</code> ä¸­å®ç°</p>
        </div>

        <div class="compare">
            <div class="compare-item">
                <div class="compare-header">8051 å®ç°</div>
<pre>
<span class="code-keyword">#include</span> <span class="code-string">&lt;STC15F2K60S2.H&gt;</span>

sbit LED = P2^0;

<span class="code-keyword">void</span> <span class="code-function">main</span>() {
    <span class="code-keyword">while</span>(<span class="code-number">1</span>) {
        LED = <span class="code-number">0</span>;
        Delay_ms(<span class="code-number">500</span>);
        LED = <span class="code-number">1</span>;
        Delay_ms(<span class="code-number">500</span>);
    }
}
</pre>
            </div>
            <div class="compare-item">
                <div class="compare-header">CH32 å®ç°</div>
<pre>
<span class="code-keyword">#include</span> <span class="code-string">"debug.h"</span>

<span class="code-keyword">void</span> <span class="code-function">main</span>(<span class="code-keyword">void</span>) {
    <span class="code-comment">// ç³»ç»Ÿåˆå§‹åŒ–</span>
    NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2);
    SystemCoreClockUpdate();
    Delay_Init();

    <span class="code-comment">// GPIOåˆå§‹åŒ–</span>
    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOC, ENABLE);

    GPIO_InitTypeDef GPIO_InitStructure = {<span class="code-number">0</span>};
    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_2;
    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;
    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
    GPIO_Init(GPIOC, &GPIO_InitStructure);

    <span class="code-keyword">while</span>(<span class="code-number">1</span>) {
        GPIO_SetBits(GPIOC, GPIO_Pin_2);
        Delay_Ms(<span class="code-number">500</span>);
        GPIO_ResetBits(GPIOC, GPIO_Pin_2);
        Delay_Ms(<span class="code-number">500</span>);
    }
}
</pre>
            </div>
        </div>

        <!-- ç¬¬å››ç«  -->
        <h2 id="chapter4">ç¬¬å››ç«  å®šæ—¶å™¨ä¸ä¸­æ–­</h2>

        <h3 id="tim-types">CH32V30x å®šæ—¶å™¨åˆ†ç±»</h3>

        <!-- å®šæ—¶å™¨åˆ†ç±»å›¾ -->
        <div class="diagram-container">
            <div class="diagram-title">å®šæ—¶å™¨ç±»å‹ä¸åŠŸèƒ½</div>
            <svg class="svg-diagram" viewBox="0 0 700 280" xmlns="http://www.w3.org/2000/svg">
                <!-- é«˜çº§å®šæ—¶å™¨ -->
                <g transform="translate(30, 30)">
                    <rect x="0" y="0" width="200" height="100" rx="10" fill="#fef2f2" stroke="#ef4444" stroke-width="2"/>
                    <text x="100" y="25" text-anchor="middle" font-size="14" font-weight="bold" fill="#991b1b">ğŸ”¥ é«˜çº§å®šæ—¶å™¨</text>
                    <text x="100" y="48" text-anchor="middle" font-size="12" fill="#b91c1c">TIM1, TIM8, TIM9, TIM10</text>
                    <line x1="20" y1="60" x2="180" y2="60" stroke="#fca5a5" stroke-width="1"/>
                    <text x="100" y="78" text-anchor="middle" font-size="11" fill="#dc2626">PWMäº’è¡¥è¾“å‡º</text>
                    <text x="100" y="93" text-anchor="middle" font-size="11" fill="#dc2626">æ­»åŒºæ§åˆ¶ã€åˆ¹è½¦</text>
                </g>

                <!-- é€šç”¨å®šæ—¶å™¨ -->
                <g transform="translate(250, 30)">
                    <rect x="0" y="0" width="200" height="100" rx="10" fill="#eff6ff" stroke="#3b82f6" stroke-width="2"/>
                    <text x="100" y="25" text-anchor="middle" font-size="14" font-weight="bold" fill="#1e40af">âš¡ é€šç”¨å®šæ—¶å™¨</text>
                    <text x="100" y="48" text-anchor="middle" font-size="12" fill="#2563eb">TIM2, TIM3, TIM4, TIM5</text>
                    <line x1="20" y1="60" x2="180" y2="60" stroke="#93c5fd" stroke-width="1"/>
                    <text x="100" y="78" text-anchor="middle" font-size="11" fill="#3b82f6">å®šæ—¶ä¸­æ–­ã€PWM</text>
                    <text x="100" y="93" text-anchor="middle" font-size="11" fill="#3b82f6">è¾“å…¥æ•è·ã€ç¼–ç å™¨</text>
                </g>

                <!-- åŸºæœ¬å®šæ—¶å™¨ -->
                <g transform="translate(470, 30)">
                    <rect x="0" y="0" width="200" height="100" rx="10" fill="#ecfdf5" stroke="#10b981" stroke-width="2"/>
                    <text x="100" y="25" text-anchor="middle" font-size="14" font-weight="bold" fill="#065f46">âœ… åŸºæœ¬å®šæ—¶å™¨</text>
                    <text x="100" y="48" text-anchor="middle" font-size="12" fill="#059669">TIM6, TIM7</text>
                    <line x1="20" y1="60" x2="180" y2="60" stroke="#6ee7b7" stroke-width="1"/>
                    <text x="100" y="78" text-anchor="middle" font-size="11" fill="#10b981">çº¯å®šæ—¶åŠŸèƒ½</text>
                    <text x="100" y="93" text-anchor="middle" font-size="11" fill="#10b981">DACè§¦å‘</text>
                </g>

                <!-- æ—¶é’Ÿæ€»çº¿æ ‡æ³¨ -->
                <g transform="translate(30, 160)">
                    <rect x="0" y="0" width="200" height="35" rx="6" fill="#fef3c7" stroke="#f59e0b" stroke-width="1"/>
                    <text x="100" y="22" text-anchor="middle" font-size="12" fill="#92400e">APB2 (96MHz)</text>
                </g>
                <g transform="translate(250, 160)">
                    <rect x="0" y="0" width="420" height="35" rx="6" fill="#dbeafe" stroke="#3b82f6" stroke-width="1"/>
                    <text x="210" y="22" text-anchor="middle" font-size="12" fill="#1e40af">APB1 (48MHz)</text>
                </g>

                <!-- æ¨èæ ‡æ³¨ -->
                <g transform="translate(250, 220)">
                    <rect x="0" y="0" width="200" height="40" rx="8" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/>
                    <text x="100" y="25" text-anchor="middle" font-size="13" font-weight="bold" fill="#166534">ğŸ’¡ å…¥é—¨æ¨è: TIM3</text>
                </g>
            </svg>
        </div>

        <h3 id="tim-basic">åŸºæœ¬å®šæ—¶ä¸­æ–­é…ç½®</h3>

        <div class="card">
            <div class="card-title">ğŸ”¢ å®šæ—¶æ—¶é—´è®¡ç®—å…¬å¼</div>
            <p style="font-size: 1.2rem; text-align: center; margin: 20px 0;">
                <strong>å®šæ—¶æ—¶é—´ = (ARR + 1) Ã— (PSC + 1) / æ—¶é’Ÿé¢‘ç‡</strong>
            </p>
            <p>ä¾‹å¦‚ï¼šARR=999, PSC=95, æ—¶é’Ÿ=96MHz</p>
            <p>å®šæ—¶æ—¶é—´ = (999+1) Ã— (95+1) / 96000000 = <strong>1ms</strong></p>
        </div>

        <!-- å®šæ—¶å™¨é…ç½®æµç¨‹ -->
        <div class="diagram-container">
            <div class="diagram-title">å®šæ—¶å™¨ä¸­æ–­é…ç½®æµç¨‹</div>
            <div class="mermaid">
flowchart TB
    A["1ï¸âƒ£ å¼€å¯TIMæ—¶é’Ÿ<br/><code>RCC_APB1PeriphClockCmd</code>"] --> B["2ï¸âƒ£ é…ç½®å®šæ—¶å™¨<br/><code>TIM_TimeBaseInit</code>"]
    B --> C["3ï¸âƒ£ ä½¿èƒ½ä¸­æ–­<br/><code>TIM_ITConfig</code>"]
    C --> D["4ï¸âƒ£ é…ç½®NVIC<br/><code>NVIC_Init</code>"]
    D --> E["5ï¸âƒ£ å¯åŠ¨å®šæ—¶å™¨<br/><code>TIM_Cmd</code>"]
    E --> F["6ï¸âƒ£ ç¼–å†™ä¸­æ–­å‡½æ•°<br/><code>TIMx_IRQHandler</code>"]

    style A fill:#fee2e2,stroke:#ef4444
    style B fill:#dbeafe,stroke:#3b82f6
    style C fill:#fef3c7,stroke:#f59e0b
    style D fill:#d1fae5,stroke:#10b981
    style E fill:#e0e7ff,stroke:#6366f1
    style F fill:#fce7f3,stroke:#ec4899
            </div>
        </div>

        <div class="compare">
            <div class="compare-item">
                <div class="compare-header">8051 å®šæ—¶å™¨é…ç½®</div>
<pre>
<span class="code-keyword">void</span> <span class="code-function">Timer0_Init</span>(<span class="code-keyword">void</span>) {
    TMOD &= <span class="code-number">0xF0</span>;
    TMOD |= <span class="code-number">0x01</span>;  <span class="code-comment">// æ¨¡å¼1</span>
    TL0 = <span class="code-number">0x18</span>;
    TH0 = <span class="code-number">0xFC</span>;    <span class="code-comment">// 1ms @12MHz</span>
    TF0 = <span class="code-number">0</span>;
    TR0 = <span class="code-number">1</span>;       <span class="code-comment">// å¯åŠ¨</span>
    ET0 = <span class="code-number">1</span>;       <span class="code-comment">// ä¸­æ–­ä½¿èƒ½</span>
    EA = <span class="code-number">1</span>;        <span class="code-comment">// æ€»ä¸­æ–­</span>
}

<span class="code-keyword">void</span> <span class="code-function">T0_ISR</span>() <span class="code-keyword">interrupt</span> <span class="code-number">1</span> {
    TH0 = <span class="code-number">0xFC</span>;
    TL0 = <span class="code-number">0x18</span>;
    <span class="code-comment">// å¤„ç†ä»£ç </span>
}
</pre>
            </div>
            <div class="compare-item">
                <div class="compare-header">CH32 å®šæ—¶å™¨é…ç½®</div>
<pre>
<span class="code-keyword">void</span> <span class="code-function">TIM3_Init</span>(<span class="code-keyword">void</span>) {
    <span class="code-comment">// 1. å¼€æ—¶é’Ÿ</span>
    RCC_APB1PeriphClockCmd(
        RCC_APB1Periph_TIM3, ENABLE);

    <span class="code-comment">// 2. é…ç½®å®šæ—¶å™¨</span>
    TIM_TimeBaseInitTypeDef TIM_InitStruct;
    TIM_InitStruct.TIM_Period = <span class="code-number">1000-1</span>;    <span class="code-comment">// ARR</span>
    TIM_InitStruct.TIM_Prescaler = <span class="code-number">96-1</span>;   <span class="code-comment">// PSC</span>
    TIM_InitStruct.TIM_ClockDivision = <span class="code-number">0</span>;
    TIM_InitStruct.TIM_CounterMode =
        TIM_CounterMode_Up;
    TIM_TimeBaseInit(TIM3, &TIM_InitStruct);

    <span class="code-comment">// 3. é…ç½®ä¸­æ–­</span>
    TIM_ITConfig(TIM3, TIM_IT_Update, ENABLE);

    <span class="code-comment">// 4. é…ç½®NVIC</span>
    NVIC_InitTypeDef NVIC_InitStruct;
    NVIC_InitStruct.NVIC_IRQChannel = TIM3_IRQn;
    NVIC_InitStruct.NVIC_IRQChannelPreemptionPriority = <span class="code-number">1</span>;
    NVIC_InitStruct.NVIC_IRQChannelSubPriority = <span class="code-number">3</span>;
    NVIC_InitStruct.NVIC_IRQChannelCmd = ENABLE;
    NVIC_Init(&NVIC_InitStruct);

    <span class="code-comment">// 5. å¯åŠ¨å®šæ—¶å™¨</span>
    TIM_Cmd(TIM3, ENABLE);
}

<span class="code-keyword">void</span> <span class="code-function">TIM3_IRQHandler</span>(<span class="code-keyword">void</span>) {
    <span class="code-keyword">if</span>(TIM_GetITStatus(TIM3, TIM_IT_Update)) {
        <span class="code-comment">// å¤„ç†ä»£ç </span>
        TIM_ClearITPendingBit(TIM3, TIM_IT_Update);
    }
}
</pre>
            </div>
        </div>

        <h3 id="tim-nvic">NVIC ä¸­æ–­æ§åˆ¶å™¨</h3>

        <!-- NVICæµç¨‹å›¾ -->
        <div class="diagram-container">
            <div class="diagram-title">NVIC ä¸­æ–­å¤„ç†æµç¨‹</div>
            <div class="mermaid">
flowchart LR
    subgraph Peripherals["å¤–è®¾ä¸­æ–­æº"]
        TIM["TIM2_IRQn<br/>TIM3_IRQn<br/>..."]
        USART["USART1_IRQn<br/>USART2_IRQn<br/>..."]
        EXTI["EXTI0_IRQn<br/>EXTI1_IRQn<br/>..."]
    end

    subgraph NVIC["NVIC æ§åˆ¶å™¨"]
        direction TB
        PRIO["ä¼˜å…ˆçº§åˆ¤æ–­<br/>æŠ¢å  > å­ä¼˜å…ˆçº§"]
        QUEUE["ä¸­æ–­é˜Ÿåˆ—"]
    end

    subgraph CPU["CPU"]
        ISR["æ‰§è¡Œä¸­æ–­æœåŠ¡å‡½æ•°<br/>TIMx_IRQHandler()"]
    end

    TIM --> NVIC
    USART --> NVIC
    EXTI --> NVIC
    NVIC --> CPU

    style PRIO fill:#fef3c7,stroke:#f59e0b
    style ISR fill:#d1fae5,stroke:#10b981
            </div>
        </div>

        <h4>NVIC ä¼˜å…ˆçº§åˆ†ç»„</h4>

        <table>
            <tr>
                <th>åˆ†ç»„</th>
                <th>æŠ¢å ä¼˜å…ˆçº§ä½æ•°</th>
                <th>å­ä¼˜å…ˆçº§ä½æ•°</th>
                <th>è¯´æ˜</th>
            </tr>
            <tr>
                <td>NVIC_PriorityGroup_0</td>
                <td>0</td>
                <td>4</td>
                <td>æ— æŠ¢å </td>
            </tr>
            <tr>
                <td>NVIC_PriorityGroup_1</td>
                <td>1</td>
                <td>3</td>
                <td>2çº§æŠ¢å </td>
            </tr>
            <tr>
                <td><strong>NVIC_PriorityGroup_2</strong></td>
                <td>2</td>
                <td>2</td>
                <td><strong>âœ… æ¨èä½¿ç”¨</strong></td>
            </tr>
            <tr>
                <td>NVIC_PriorityGroup_3</td>
                <td>3</td>
                <td>1</td>
                <td>8çº§æŠ¢å </td>
            </tr>
            <tr>
                <td>NVIC_PriorityGroup_4</td>
                <td>4</td>
                <td>0</td>
                <td>16çº§æŠ¢å </td>
            </tr>
        </table>

        <h3 id="tim-exercise">å®æˆ˜ç»ƒä¹ ï¼šå®šæ—¶å™¨LED</h3>

        <div class="exercise">
            <div class="exercise-title">ğŸ“ ç»ƒä¹ 2ï¼šç”¨TIM3ä¸­æ–­å®ç°1ç§’LEDç¿»è½¬</div>
            <p>æ”¹é€ ä½ çš„main.cï¼Œå°†Delay_Msæ”¹ä¸ºå®šæ—¶å™¨ä¸­æ–­æ–¹å¼</p>
        </div>

<pre>
<span class="code-keyword">#include</span> <span class="code-string">"debug.h"</span>

<span class="code-comment">// ä¸­æ–­å‡½æ•°å£°æ˜ï¼ˆWCHç‰¹æœ‰å±æ€§ï¼‰</span>
<span class="code-keyword">void</span> TIM3_IRQHandler(<span class="code-keyword">void</span>) __attribute__((interrupt(<span class="code-string">"WCH-Interrupt-fast"</span>)));

<span class="code-comment">// å…¨å±€å˜é‡</span>
<span class="code-keyword">volatile</span> uint32_t uwTick = <span class="code-number">0</span>;
<span class="code-keyword">volatile</span> uint8_t Led_Flag = <span class="code-number">0</span>;

<span class="code-comment">// TIM3åˆå§‹åŒ–ï¼š1msä¸­æ–­</span>
<span class="code-keyword">void</span> <span class="code-function">TIM3_Init</span>(<span class="code-keyword">void</span>)
{
    RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM3, ENABLE);

    TIM_TimeBaseInitTypeDef TIM_TimeBaseInitStruct = {<span class="code-number">0</span>};
    TIM_TimeBaseInitStruct.TIM_Period = <span class="code-number">1000</span> - <span class="code-number">1</span>;
    TIM_TimeBaseInitStruct.TIM_Prescaler = <span class="code-number">96</span> - <span class="code-number">1</span>;
    TIM_TimeBaseInitStruct.TIM_ClockDivision = <span class="code-number">0</span>;
    TIM_TimeBaseInitStruct.TIM_CounterMode = TIM_CounterMode_Up;
    TIM_TimeBaseInit(TIM3, &TIM_TimeBaseInitStruct);

    TIM_ITConfig(TIM3, TIM_IT_Update, ENABLE);

    NVIC_InitTypeDef NVIC_InitStruct = {<span class="code-number">0</span>};
    NVIC_InitStruct.NVIC_IRQChannel = TIM3_IRQn;
    NVIC_InitStruct.NVIC_IRQChannelPreemptionPriority = <span class="code-number">1</span>;
    NVIC_InitStruct.NVIC_IRQChannelSubPriority = <span class="code-number">3</span>;
    NVIC_InitStruct.NVIC_IRQChannelCmd = ENABLE;
    NVIC_Init(&NVIC_InitStruct);

    TIM_Cmd(TIM3, ENABLE);
}

<span class="code-comment">// TIM3ä¸­æ–­æœåŠ¡å‡½æ•°</span>
<span class="code-keyword">void</span> <span class="code-function">TIM3_IRQHandler</span>(<span class="code-keyword">void</span>)
{
    <span class="code-keyword">if</span>(TIM_GetITStatus(TIM3, TIM_IT_Update) != RESET)
    {
        uwTick++;
        <span class="code-keyword">if</span>(uwTick >= <span class="code-number">1000</span>) {
            uwTick = <span class="code-number">0</span>;
            Led_Flag ^= <span class="code-number">1</span>;
            <span class="code-keyword">if</span>(Led_Flag) GPIO_SetBits(GPIOC, GPIO_Pin_2);
            <span class="code-keyword">else</span> GPIO_ResetBits(GPIOC, GPIO_Pin_2);
        }
        TIM_ClearITPendingBit(TIM3, TIM_IT_Update);
    }
}

<span class="code-keyword">int</span> <span class="code-function">main</span>(<span class="code-keyword">void</span>)
{
    NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2);
    SystemCoreClockUpdate();
    Delay_Init();
    USART_Printf_Init(<span class="code-number">115200</span>);

    <span class="code-comment">// LEDåˆå§‹åŒ–</span>
    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOC, ENABLE);
    GPIO_InitTypeDef GPIO_InitStruct = {<span class="code-number">0</span>};
    GPIO_InitStruct.GPIO_Pin = GPIO_Pin_2;
    GPIO_InitStruct.GPIO_Mode = GPIO_Mode_Out_PP;
    GPIO_InitStruct.GPIO_Speed = GPIO_Speed_50MHz;
    GPIO_Init(GPIOC, &GPIO_InitStruct);

    TIM3_Init();

    <span class="code-keyword">while</span>(<span class="code-number">1</span>) { }
}
</pre>

        <!-- ç¬¬äº”ç«  -->
        <h2 id="chapter5">ç¬¬äº”ç«  ä¸²å£é€šä¿¡</h2>

        <h3 id="usart-init">USART åˆå§‹åŒ–</h3>

        <!-- USARTæµç¨‹å›¾ -->
        <div class="diagram-container">
            <div class="diagram-title">USART é€šä¿¡åŸç†</div>
            <svg class="svg-diagram" viewBox="0 0 700 200" xmlns="http://www.w3.org/2000/svg">
                <!-- CH32 -->
                <rect x="50" y="50" width="200" height="100" rx="12" fill="#eff6ff" stroke="#3b82f6" stroke-width="2"/>
                <text x="150" y="80" text-anchor="middle" font-size="16" font-weight="bold" fill="#1e40af">CH32V30x</text>
                <text x="150" y="105" text-anchor="middle" font-size="12" fill="#3b82f6">USART1</text>
                <text x="150" y="125" text-anchor="middle" font-size="11" fill="#64748b">TX: PA9 | RX: PA10</text>

                <!-- PC -->
                <rect x="450" y="50" width="200" height="100" rx="12" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                <text x="550" y="80" text-anchor="middle" font-size="16" font-weight="bold" fill="#92400e">ç”µè„‘</text>
                <text x="550" y="105" text-anchor="middle" font-size="12" fill="#f59e0b">ä¸²å£è°ƒè¯•åŠ©æ‰‹</text>
                <text x="550" y="125" text-anchor="middle" font-size="11" fill="#64748b">115200-8-N-1</text>

                <!-- TXçº¿ -->
                <line x1="250" y1="85" x2="450" y2="85" stroke="#10b981" stroke-width="3"/>
                <polygon points="440,80 450,85 440,90" fill="#10b981"/>
                <text x="350" y="75" text-anchor="middle" font-size="12" font-weight="bold" fill="#10b981">TX â†’ RX</text>

                <!-- RXçº¿ -->
                <line x1="450" y1="115" x2="250" y2="115" stroke="#ef4444" stroke-width="3"/>
                <polygon points="260,110 250,115 260,120" fill="#ef4444"/>
                <text x="350" y="135" text-anchor="middle" font-size="12" font-weight="bold" fill="#ef4444">RX â† TX</text>

                <!-- USBè½¬TTL -->
                <rect x="330" y="155" width="100" height="30" rx="6" fill="#e0e7ff" stroke="#6366f1" stroke-width="1"/>
                <text x="380" y="175" text-anchor="middle" font-size="11" fill="#4f46e5">USBè½¬TTL</text>
            </svg>
        </div>

        <div class="tip">
            <div class="tip-title">ğŸ’¡ å¥½æ¶ˆæ¯</div>
            <p>ä½ çš„å·¥ç¨‹åŒ…ä¸­ <code>Debug/debug.c</code> å·²ç»å®ç°äº†printfé‡å®šå‘ï¼Œç›´æ¥è°ƒç”¨ <code>USART_Printf_Init(115200)</code> å³å¯ä½¿ç”¨ <code>printf()</code>ï¼</p>
        </div>

<pre>
<span class="code-keyword">#include</span> <span class="code-string">"debug.h"</span>

<span class="code-keyword">int</span> <span class="code-function">main</span>(<span class="code-keyword">void</span>)
{
    NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2);
    SystemCoreClockUpdate();
    Delay_Init();

    <span class="code-comment">// ä¸€è¡Œæå®šä¸²å£printf</span>
    <span class="code-function">USART_Printf_Init</span>(<span class="code-number">115200</span>);

    printf(<span class="code-string">"Hello CH32V30x!\n"</span>);
    printf(<span class="code-string">"System Clock: %d Hz\n"</span>, SystemCoreClock);

    <span class="code-keyword">int</span> count = <span class="code-number">0</span>;
    <span class="code-keyword">while</span>(<span class="code-number">1</span>) {
        printf(<span class="code-string">"Count: %d\n"</span>, count++);
        Delay_Ms(<span class="code-number">1000</span>);
    }
}
</pre>

        <!-- ç¬¬å…­ç«  -->
        <h2 id="chapter6">ç¬¬å…­ç«  ç»¼åˆé¡¹ç›®</h2>

        <h3 id="scheduler">ç§»æ¤ä½ çš„ä»»åŠ¡è°ƒåº¦å™¨</h3>

        <!-- ä»»åŠ¡è°ƒåº¦å™¨æ¶æ„å›¾ -->
        <div class="diagram-container">
            <div class="diagram-title">ä»»åŠ¡è°ƒåº¦å™¨æ¶æ„</div>
            <div class="mermaid">
flowchart TB
    subgraph HW["ç¡¬ä»¶å±‚"]
        TIM["TIM3<br/>1msä¸­æ–­"]
    end

    subgraph TICK["æ—¶åŸºå±‚"]
        UWTICK["uwTick++<br/>å…¨å±€æ—¶é—´æˆ³"]
    end

    subgraph SCHED["è°ƒåº¦å™¨"]
        direction LR
        CHECK["æ£€æŸ¥å„ä»»åŠ¡<br/>æ˜¯å¦åˆ°æœŸ"]
        EXEC["æ‰§è¡Œåˆ°æœŸä»»åŠ¡"]
    end

    subgraph TASKS["ä»»åŠ¡åˆ—è¡¨"]
        T1["Led_Task<br/>500ms"]
        T2["Key_Task<br/>10ms"]
        T3["Display_Task<br/>100ms"]
        T4["Sensor_Task<br/>200ms"]
    end

    TIM --> |"ä¸­æ–­"| UWTICK
    UWTICK --> SCHED
    SCHED --> TASKS

    style TIM fill:#fee2e2,stroke:#ef4444
    style UWTICK fill:#fef3c7,stroke:#f59e0b
    style CHECK fill:#dbeafe,stroke:#3b82f6
    style EXEC fill:#d1fae5,stroke:#10b981
            </div>
        </div>

<pre>
<span class="code-keyword">#include</span> <span class="code-string">"debug.h"</span>

<span class="code-comment">/*==================== ä»»åŠ¡è°ƒåº¦å™¨ ====================*/</span>

<span class="code-keyword">volatile</span> uint32_t uwTick = <span class="code-number">0</span>;

<span class="code-keyword">typedef struct</span> {
    <span class="code-keyword">void</span> (*task_func)(<span class="code-keyword">void</span>);
    uint32_t rate_ms;
    uint32_t last_ms;
} task_t;

<span class="code-keyword">void</span> Led_Task(<span class="code-keyword">void</span>);
<span class="code-keyword">void</span> Key_Task(<span class="code-keyword">void</span>);
<span class="code-keyword">void</span> Display_Task(<span class="code-keyword">void</span>);

task_t Scheduler_Task[] = {
    {Led_Task,      <span class="code-number">500</span>,  <span class="code-number">0</span>},
    {Key_Task,      <span class="code-number">10</span>,   <span class="code-number">0</span>},
    {Display_Task,  <span class="code-number">100</span>,  <span class="code-number">0</span>},
};

<span class="code-keyword">const</span> uint8_t task_num = <span class="code-keyword">sizeof</span>(Scheduler_Task) / <span class="code-keyword">sizeof</span>(task_t);

<span class="code-keyword">void</span> <span class="code-function">Scheduler_Run</span>(<span class="code-keyword">void</span>)
{
    <span class="code-keyword">for</span>(uint8_t i = <span class="code-number">0</span>; i < task_num; i++) {
        uint32_t now = uwTick;
        <span class="code-keyword">if</span>(now - Scheduler_Task[i].last_ms >= Scheduler_Task[i].rate_ms) {
            Scheduler_Task[i].last_ms = now;
            Scheduler_Task[i].task_func();
        }
    }
}

<span class="code-comment">/*==================== ä»»åŠ¡å®ç° ====================*/</span>

uint8_t led_state = <span class="code-number">0</span>;

<span class="code-keyword">void</span> <span class="code-function">Led_Task</span>(<span class="code-keyword">void</span>) {
    led_state ^= <span class="code-number">1</span>;
    <span class="code-keyword">if</span>(led_state) GPIO_SetBits(GPIOC, GPIO_Pin_2);
    <span class="code-keyword">else</span> GPIO_ResetBits(GPIOC, GPIO_Pin_2);
}

<span class="code-keyword">void</span> <span class="code-function">Key_Task</span>(<span class="code-keyword">void</span>) {
    <span class="code-comment">// æŒ‰é”®æ‰«æ</span>
}

<span class="code-keyword">void</span> <span class="code-function">Display_Task</span>(<span class="code-keyword">void</span>) {
    <span class="code-keyword">static</span> uint32_t count = <span class="code-number">0</span>;
    printf(<span class="code-string">"Tick: %lu\n"</span>, count++);
}

<span class="code-comment">/*==================== ä¸»å‡½æ•° ====================*/</span>

<span class="code-keyword">void</span> TIM3_IRQHandler(<span class="code-keyword">void</span>) __attribute__((interrupt(<span class="code-string">"WCH-Interrupt-fast"</span>)));

<span class="code-keyword">void</span> <span class="code-function">TIM3_IRQHandler</span>(<span class="code-keyword">void</span>) {
    <span class="code-keyword">if</span>(TIM_GetITStatus(TIM3, TIM_IT_Update) != RESET) {
        uwTick++;
        TIM_ClearITPendingBit(TIM3, TIM_IT_Update);
    }
}

<span class="code-keyword">int</span> <span class="code-function">main</span>(<span class="code-keyword">void</span>)
{
    NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2);
    SystemCoreClockUpdate();
    Delay_Init();
    USART_Printf_Init(<span class="code-number">115200</span>);

    <span class="code-comment">// GPIO/TIMåˆå§‹åŒ–...</span>

    <span class="code-keyword">while</span>(<span class="code-number">1</span>) {
        Scheduler_Run();
    }
}
</pre>

        <h3 id="template">å·¥ç¨‹æ¨¡æ¿ç»“æ„å»ºè®®</h3>

        <!-- å·¥ç¨‹ç»“æ„å›¾ -->
        <div class="diagram-container">
            <div class="diagram-title">æ¨èçš„å·¥ç¨‹ç›®å½•ç»“æ„</div>
            <div class="mermaid">
flowchart TB
    ROOT["ğŸ“ ä½ çš„CH32å·¥ç¨‹"] --> CORE["ğŸ“ Core<br/><i>RISC-Vå†…æ ¸</i>"]
    ROOT --> DEBUG["ğŸ“ Debug<br/><i>è°ƒè¯•å·¥å…·</i>"]
    ROOT --> PERIPH["ğŸ“ Peripheral<br/><i>å®˜æ–¹å¤–è®¾åº“</i>"]
    ROOT --> STARTUP["ğŸ“ Startup<br/><i>å¯åŠ¨æ–‡ä»¶</i>"]
    ROOT --> DRIVER["ğŸ“ Driver ğŸ†•<br/><i>ä½ çš„é©±åŠ¨å±‚</i>"]
    ROOT --> APP["ğŸ“ App ğŸ†•<br/><i>åº”ç”¨å±‚</i>"]
    ROOT --> USER["ğŸ“ User<br/><i>ä¸»ç¨‹åº</i>"]

    DRIVER --> D1["bsp_led.c/h"]
    DRIVER --> D2["bsp_key.c/h"]
    DRIVER --> D3["bsp_timer.c/h"]

    APP --> A1["scheduler.c/h"]
    APP --> A2["task_led.c/h"]
    APP --> A3["task_key.c/h"]

    USER --> U1["main.c"]
    USER --> U2["ch32v30x_it.c"]

    style ROOT fill:#eff6ff,stroke:#3b82f6
    style DRIVER fill:#dcfce7,stroke:#22c55e
    style APP fill:#fef3c7,stroke:#f59e0b
            </div>
        </div>

        <!-- é™„å½• -->
        <h2 id="appendix">é™„å½•</h2>

        <h3 id="api-quick">API é€ŸæŸ¥è¡¨</h3>

        <h4>GPIO</h4>
        <table>
            <tr><th>åŠŸèƒ½</th><th>å‡½æ•°</th></tr>
            <tr><td>åˆå§‹åŒ–</td><td><code>GPIO_Init(GPIOx, &InitStruct)</code></td></tr>
            <tr><td>ç½®é«˜</td><td><code>GPIO_SetBits(GPIOx, GPIO_Pin_x)</code></td></tr>
            <tr><td>ç½®ä½</td><td><code>GPIO_ResetBits(GPIOx, GPIO_Pin_x)</code></td></tr>
            <tr><td>å†™ä½</td><td><code>GPIO_WriteBit(GPIOx, GPIO_Pin_x, BitVal)</code></td></tr>
            <tr><td>å†™ç«¯å£</td><td><code>GPIO_Write(GPIOx, PortVal)</code></td></tr>
            <tr><td>è¯»è¾“å…¥</td><td><code>GPIO_ReadInputDataBit(GPIOx, GPIO_Pin_x)</code></td></tr>
        </table>

        <h4>å®šæ—¶å™¨</h4>
        <table>
            <tr><th>åŠŸèƒ½</th><th>å‡½æ•°</th></tr>
            <tr><td>åŸºæœ¬åˆå§‹åŒ–</td><td><code>TIM_TimeBaseInit(TIMx, &InitStruct)</code></td></tr>
            <tr><td>ä½¿èƒ½å®šæ—¶å™¨</td><td><code>TIM_Cmd(TIMx, ENABLE)</code></td></tr>
            <tr><td>ä¸­æ–­é…ç½®</td><td><code>TIM_ITConfig(TIMx, TIM_IT_Update, ENABLE)</code></td></tr>
            <tr><td>è·å–ä¸­æ–­çŠ¶æ€</td><td><code>TIM_GetITStatus(TIMx, TIM_IT_Update)</code></td></tr>
            <tr><td>æ¸…é™¤ä¸­æ–­æ ‡å¿—</td><td><code>TIM_ClearITPendingBit(TIMx, TIM_IT_Update)</code></td></tr>
        </table>

        <h3 id="troubleshooting">å¸¸è§é—®é¢˜æ’æŸ¥</h3>

        <!-- é—®é¢˜æ’æŸ¥æµç¨‹å›¾ -->
        <div class="diagram-container">
            <div class="diagram-title">GPIOä¸å·¥ä½œæ’æŸ¥æµç¨‹</div>
            <div class="mermaid">
flowchart TB
    START["GPIOä¸å·¥ä½œ"] --> Q1{"å¼€äº†RCCæ—¶é’Ÿ?"}
    Q1 -->|"å¦"| A1["æ·»åŠ  RCC_APB2PeriphClockCmd"]
    Q1 -->|"æ˜¯"| Q2{"æ¨¡å¼æ­£ç¡®?"}
    Q2 -->|"å¦"| A2["æ£€æŸ¥ GPIO_Mode"]
    Q2 -->|"æ˜¯"| Q3{"å¼•è„šæ­£ç¡®?"}
    Q3 -->|"å¦"| A3["æ£€æŸ¥ GPIO_Pin"]
    Q3 -->|"æ˜¯"| Q4{"ç¡¬ä»¶è¿æ¥?"}
    Q4 -->|"å¦"| A4["æ£€æŸ¥æ¥çº¿"]
    Q4 -->|"æ˜¯"| A5["æ£€æŸ¥å…¶ä»–ä»£ç é€»è¾‘"]

    style START fill:#fee2e2,stroke:#ef4444
    style A1 fill:#dcfce7,stroke:#22c55e
    style A2 fill:#dcfce7,stroke:#22c55e
    style A3 fill:#dcfce7,stroke:#22c55e
    style A4 fill:#dcfce7,stroke:#22c55e
            </div>
        </div>

        <div class="card">
            <div class="card-title">âŒ é—®é¢˜1ï¼šGPIOä¸å·¥ä½œ</div>
            <p><strong>ç—‡çŠ¶</strong>ï¼šè®¾ç½®äº†GPIOä½†å¼•è„šæ— è¾“å‡º</p>
            <p><strong>åŸå› </strong>ï¼š99%æ˜¯å¿˜è®°å¼€æ—¶é’Ÿ</p>
            <p><strong>è§£å†³</strong>ï¼šæ£€æŸ¥ <code>RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOx, ENABLE)</code></p>
        </div>

        <div class="card">
            <div class="card-title">âŒ é—®é¢˜2ï¼šä¸­æ–­ä¸è§¦å‘</div>
            <p><strong>æ£€æŸ¥æ¸…å•</strong>ï¼š</p>
            <ol>
                <li>å¤–è®¾æ—¶é’Ÿæ˜¯å¦å¼€å¯ï¼Ÿ</li>
                <li>å¤–è®¾ä¸­æ–­æ˜¯å¦ä½¿èƒ½ï¼Ÿ(<code>TIM_ITConfig</code>)</li>
                <li>NVICæ˜¯å¦é…ç½®ï¼Ÿ(<code>NVIC_Init</code>)</li>
                <li>ä¸­æ–­å‡½æ•°åæ˜¯å¦æ­£ç¡®ï¼Ÿ</li>
                <li>æ˜¯å¦æ·»åŠ äº† <code>__attribute__((interrupt("WCH-Interrupt-fast")))</code>ï¼Ÿ</li>
            </ol>
        </div>

        <div class="card">
            <div class="card-title">âŒ é—®é¢˜3ï¼šprintfæ— è¾“å‡º</div>
            <p><strong>æ£€æŸ¥æ¸…å•</strong>ï¼š</p>
            <ol>
                <li>æ˜¯å¦è°ƒç”¨äº† <code>USART_Printf_Init(115200)</code>ï¼Ÿ</li>
                <li>ä¸²å£æ³¢ç‰¹ç‡æ˜¯å¦åŒ¹é…ï¼Ÿ</li>
                <li>TXå¼•è„šæ¥çº¿æ˜¯å¦æ­£ç¡®ï¼Ÿ(é»˜è®¤PA9)</li>
            </ol>
        </div>

        <hr style="margin: 50px 0;">

        <div style="text-align: center; color: var(--text-light);">
            <p>ğŸ“š CH32V30x å­¦ä¹ æŒ‡å— Â· åŸºäº v2.18 å·¥ç¨‹åŒ…</p>
            <p>ç¥ä½ å­¦ä¹ é¡ºåˆ©ï¼ğŸš€</p>
        </div>

    </main>

    <script>
        // åˆå§‹åŒ– Mermaid
        mermaid.initialize({
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                primaryColor: '#dbeafe',
                primaryBorderColor: '#3b82f6',
                primaryTextColor: '#1e40af',
                secondaryColor: '#d1fae5',
                secondaryBorderColor: '#10b981',
                tertiaryColor: '#fef3c7',
                tertiaryBorderColor: '#f59e0b',
                lineColor: '#64748b',
                textColor: '#1e293b',
                fontSize: '14px'
            },
            flowchart: {
                curve: 'basis',
                padding: 20
            }
        });
    </script>
</body>
</html>
